(function() {

  var Draft = function(selector, scope = "draft") {
    this.$form = document.querySelector(selector)
    this.autoSaves = []
    this._scope = scope

    this.$form.addEventListener('submit', this.clean.bind(this))

    return this
  }

  Draft.prototype.register = function(selector) {
    var $el = this.$form.querySelector(selector)
    $el.addEventListener('keyup', function(ev) { this.save(selector, ev) }.bind(this) )
    this.autoSaves.push(selector)
    this.restore(selector, $el)
  }

  Draft.prototype.save = function(selector, ev) {
    var $target = ev.target

    if(window.localStorage) {
      if($target.value.length > 0) {
        localStorage.setItem(this.scope(selector), $target.value)
      } else  {
        localStorage.removeItem(this.scope(selector))
      }
    }
  }

  Draft.prototype.restore = function(selector, $el) {
    $el = $el || this.$form.querySelector(selector)

    if(window.localStorage) {
      var draftData = localStorage.getItem(this.scope(selector))
      if(draftData && $el.value.length <= 0) {
        $el.value = draftData
      }
    }
  }

  Draft.prototype.clean = function() {
    if(!window.localStorage) {
      return
    }

    var selector = ""
    for(var index in this.autoSaves) {
      selector = this.autoSaves[index]
      localStorage.removeItem(this.scope(selector))
    }
  }

  Draft.prototype.scope = function(selector) {
    return this._scope + "@" + selector
  }

  window.Draft = Draft

}())
